/*!
 * widgets
 * @Version 1.0.0
 * @Author HanRubing <qdhrb@sina.com>
*/
const wgs=function(){"use strict";function t(t){return"function"==typeof t}function e(t){return"string"==typeof t}function n(t){return"number"==typeof t}function r(t){if(null===t||"object"!=typeof t)return!1;let e=t;for(;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}String.prototype.decode||(String.prototype.decode=function(t,e){let n=t[this];return null!=n?n:e||""}),Array.prototype.remove||(Array.prototype.remove=function(t){let e=this.indexOf(t);return e>=0&&this.splice(e,1),this}),Array.prototype.last||(Array.prototype.last=function(){return this.length>0?this[this.length-1]:null}),Date.prototype.format=function(t){return t.replace(/{(y+|M+|d+|h+|m+|s+|S)}/g,((t,e)=>{let n;switch(e.charAt(0)){case"y":return String(this.getFullYear()).substr(4-e.length);case"M":n=this.getMonth()+1;break;case"d":n=this.getDate();break;case"h":n=this.getHours();break;case"m":n=this.getMinutes();break;case"s":n=this.getSeconds();break;case"S":return n=this.getMilliseconds(),n>=100?n:n>=10?"0"+n:"00"+n;default:return""}return e.length>1?n>=10?n:"0"+n:n}))},window.addEventListener("unhandledrejection",(t=>{console.warn(`UNHANDLED PROMISE REJECTION: ${t.reason}`)}));let s=/[^ \t\r\n,;]+/g;function o(t,e){return t?t.match(e||s):[]}let i=1e3,l=null;let a={"req.type":"json","req.tmo":1e4,"req.error":t=>{console.error("Request failed:",t)}};function u(t,e){return a.hasOwnProperty(t)?a[t]:arguments.length>=2?e:null}let d={};function h(t,e,n){t=t?t.toUpperCase():"GET";let s=e instanceof Object?e:{url:e,params:n};if(!s.url)throw"Need url";if(!s.params&&(s.params=null),!s.tmo&&(s.tmo=u("req.tmo",0)),!s.type&&(s.type=u("req.type")),r(s.params)){let t=new FormData;for(let e of Object.keys(s.params))t.append(e,s.params[e]);s.params=t}return new Promise(((e,n)=>{let r=new XMLHttpRequest;s.tmo>0&&(r.timeout=s.tmo),s.type&&(req.responseType=s.type),r.onerror=()=>n({type:"request",code:r.status,msg:r.statusText}),r.onabort=()=>n({type:"request",code:-2,msg:"Abort"}),r.ontimeout=()=>n({type:"request",code:-1,msg:"Timeout"}),r.onload=()=>{if(r.status>=200&&r.status<300||304===r.status){let t="string"==typeof r.response&&"application/json"===r.getResponseHeader("content-type");e(t?JSON.parse(r.response):r.response)}else n({type:"request",code:r.status,msg:r.statusText})},r.open(t,s.url),r.send(s.params)}))}class m{dom=null;constructor(t,n){this.dom=t instanceof HTMLElement?t:e(t)?document.createElement(t):null,n&&this.dom&&(this.dom.className=n)}static register(t,e){if(!e){e=new this}for(let n of o(t))n&&(c[n]=e)}isValid(){return!!this.dom}isOffline(){return this.dom&&!this.dom.parentElement}setDom(t){if(this.dom){let e=this.dom.parentElement;e&&(t?e.replaceChild(t,this.dom):e.removeChild(this.dom))}return this.dom=t,this}offline(){let t=this.dom&&this.dom.parentElement;return t&&t.removeChild(this.dom),this}empty(){return this.dom&&(this.dom.innerHTML=""),this}content(...t){this.empty();let n=this.dom;for(let r of t)r instanceof m?n.appendChild(r.dom):r instanceof Node?n.appendChild(r):e(r)&&this.dom.appendChild(document.createTextNode(r));return this}append(e,n,r){let s=e instanceof m?e:e instanceof HTMLElement?new m(e):e&&function(t,e){let n=c[t];return n?n(e):new m(t,e)}(e);return s&&(n&&s.mclazz(n),r&&(t(r)?r(s):s.innerHTML=r),this.dom.appendChild(s.dom)),this}appendTo(t){let e=t instanceof m?t.dom:t;return e&&e.appendChild(this.dom),this}insert(t,e){if(e instanceof m&&(e=e.dom),this.dom.parentElement||"afterbegin"===t||"beforeend"===t)this.dom.insertAdjacentElement(t,e);else{if(!e.parentElement)throw"Widget.insert failed, no parent: "+t;e.insertAdjacentElement("afterend"===t?"beforebegin":"afterend",this.dom)}return this}tag(){return this.dom.tagName}id(t){return arguments.length>=1?(t&&(this.dom.id=t),this):this.dom.id}static setAttr(t,e,n){null!=n&&null!=n?t.setAttribute(e,n):t.removeAttribute(e)}attr(t,e){if(t instanceof Object){for(let e of Object.keys(t))m.setAttr(this.dom,e,t[e]);return this}return arguments.length>=2?(m.setAttr(this.dom,t,e),this):this.dom.getAttribute(t)}data(t,e){return arguments.length>=2?(this.dom.dataset[t]=null!=e&&null!=e?e:"",this):this.dom.dataset[t]}html(t){return arguments.length>=1?(this.dom.innerHTML=null!=t&&null!=t?t:"",this):this.dom.innerHTML}text(t){return arguments.length>=1?(this.dom.textContent=null!=t&&null!=t?t:"",this):this.dom.textContent}val(t){let e=this.dom,n="value"in e&&!(e instanceof HTMLLIElement);return arguments.length>=1?(null!=t&&(n?e.value=t:e.setAttribute("value",null!=t?t:"")),this):n?e.value:e.getAttribute("value")||""}validate(t){if(t){let e=this.data("id");e&&(t[e]=this.val())}return!0}style(t,e){if(t instanceof Object){for(let e of Object.keys(t))this.dom.style[e]=t[e];return this}return arguments.length>=2?(this.dom.style[t]=e,this):this.dom.style[t]}grid(t){this.dom.classList.add("wgs-grid");let e=this.dom.style;return t.cols&&(e["grid-template-columns"]=t.cols),t.rows&&(e["grid-template-rows"]=t.rows),t.colAuto&&(e["grid-auto-cols"]=t.colAuto),t.rowAuto&&(e["grid-auto-rows"]=t.rowAuto),t.gap&&(e.gap=t.gap),t.align&&(e["justify-items"]=t.align),t.alignV&&(e["align-items"]=t.alignV),this}clazz(t){return arguments.length>=1?(this.dom.className=t,this):this.dom.className}mclazz(t,e){let n=this.dom.classList;for(let e of o(t))n.add(e);for(let t of o(e))n.remove(t);return this}hasClazz(t){return this.dom.classList.contains(t)}toggleClazz(t,e){return 1===arguments.length?this.dom.classList.toggle(t):arguments.length>=2&&this.dom.classList.toggle(t,e)}choice(n,r,s){let o,i;33===r.charCodeAt(0)?(o="remove",i="add",r=r.substring(1)):(o="add",i="remove");let l=this.dom.querySelectorAll(n),a=0;if(t(s))for(let t of l)s(t)?(++a,t.classList[o](r)):t.classList[i](r);else{let t=e(s)?this.dom.querySelector(s):s&&s.dom||s;for(let e of l)t==e?(++a,e.classList[o](r)):e.classList[i](r)}return a}show(){this.dom.classList.remove("wgs-hidden")}hide(){this.dom.classList.add("wgs-hidden")}query(e,n){let r=this.dom.querySelector(e);return t(n)?n(r):r&&new m(r)}queryAll(e,n){let r=this.dom.querySelectorAll(e),s=[],o=t(n);for(let t of r)s.push(o?n(t):new m(t));return s}nearby(e,r,s){let o=_nearby_map[e];if(!o)return null;r||(r=1);let i=this.dom[o];if(n(r))for(;i&&--r>=1;)i=i[o];else for(;i&&!i.matches(r);)i=i[o];return t(s)?s(i):i&&new m(i)}child(e,r){let s=this.dom;if(n(e)){let t=s.children;e<0&&(e=t.length+e),s=e>=0&&e<t.length?t[e]:null}else for(s=s.firstElementChild;s&&!s.matches(e);s=s.nextElementSibling);return t(r)?r(s):s&&new m(s)}children(e,n){let r=[],s=[],o=t(n);for(let t=this.dom.firstElementChild;t;t=t.nextElementSibling)e&&!t.matches(e)||r.push(t);for(let t of r)s.push(o?n(t):new m(t));return s}findIndex(t){let e=t instanceof m?t.dom:t,n=this.dom.firstElementChild,r=0;for(;n;){if(n===e)return r;++r,n=n.nextElementSibling}return-1}on(e,n,r){if(2===arguments.length)this.dom["on"+e]=t(n)?n:null;else if(arguments.length>=3){let s=this.dom.querySelectorAll(e);t(r)||(r=null);for(let t of s)t["on"+n]=r}return this}listen(e,n,r){if(2===arguments.length&&t(n))this.dom.addEventListener(e,n);else if(arguments.length>=3&&t(r)){let t=this.dom.querySelectorAll(e);for(let e of t)e.addEventListener(n,r)}return this}dispatch(t,e,n){let r=null==e?new Event(t,{bubbles:!0,cancelable:!0}):new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:e});return n>=0?setTimeout((()=>this.dom.dispatchEvent(r)),n):this.dom.dispatchEvent(r),r}findByEvent(e,n,r){let s=e instanceof Event?e.target:e;for(n=n.toUpperCase();s&&s.tagName!==n;){if(s===this.dom)return null;s=s.parentElement}return s&&(t(r)?r(s):new m(s))}}let c={};const f={i2a:function(t){return Array.isArray(t)?t:[t]},isFunc:t,isStr:e,isNum:n,isPlainObject:r,rand:function(t,e,n){let r=(e-t)*Math.random()+t;return n?Math.round(r*n)/n:r},fix:function(t,e){return Math.round(t*e)/e},split:o,clone:function(t){return function t(e){if(null===e||"object"!=typeof e)return e;let n=Array.isArray(e)?[]:{};for(let r in e)e.hasOwnProperty(r)&&(n[r]=t(e[r]));return n}(t)},walkAT:function(t,e,n,r){!function t(e,s){for(let o of s){let s=r(e,o),i=o[n];s&&Array.isArray(i)&&t(s,i)}}(t,e)},findAT:function(t,e,n){return function t(r){for(let s of r){if(n(s))return s;if(Array.isArray(s[e])){let n=t(s[e]);if(void 0!==n)return n}}}(t)},getItem:function(t,...e){let n=t;for(let t of e){if(!n)return null;n=n[t]}return n},setItem:function(t,...e){if(e.length<=1)return;let n=t,r=e.length-2;for(let t=0;t<r;++t){let r=n[e[t]];n=r instanceof Object?r:n[e[t]]="number"==typeof e[t+1]?[]:{}}n[e[r]]=e[r+1]},nextId:function(t){return l=t+"_"+ ++i},lastId:function(){return l},urlParam:function(t,e,n){let r=new URL(t||"",location.href);return arguments.length<=2?r.searchParams.get(e):(r.searchParams.set(e,n),r.toString())},request:h,load:function(t,e){return h("get",t,e)},post:function(t,e){return h("post",t,e)},loadScripts:function(t){let e=t.length,n=[];return new Promise((r=>{for(let s of t){if(d[s]){--e<=0&&r(n);continue}d[s]=!0;let t=document.createElement("script");t.type="text/javascript",t.onerror=t=>{console.error(t),n.push(t),--e<=0&&r(n)},t.onload=()=>{--e<=0&&r(n)},document.head.appendChild(t),t.src=s}}))},Widget:m};return f}();
